<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-fab-transitions/paper-fab-transitions.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../bower_components/paper-divider/paper-divider.html">

<dom-module id="cafienne-definition-view">
  <template>
    <style>
      :host {
        display: block;
        --paper-input-container-label: {
          color: var(--dark-primary-color);
        }
      }

      #definitionview {
        width: 100%;
      }

      .bottom-right {
        position: absolute;
        bottom: 10px;
        right: 10px;
      }

      paper-input {
        max-width: 90%;
        margin: 25px;
      }

      paper-textarea {
        max-width: 90%;
        margin: 25px;
        background-color: rgba(0, 0, 0, 0.05);
      }

      paper-toast {
        z-index: 1000;
      }
    </style>

    <iron-ajax id="getDefinitionXML"
      handle-as="document"
      on-response="_getDefinitionInfo"></iron-ajax>
    <iron-ajax id="startCase"
               method = "POST"
               content-type = "application/json"
               handle-as = "json"
               last-response="{{startresult}}"
               on-response="_handleStartCaseResult"
               on-error="_handleStartCaseResult"></iron-ajax>

    <paper-card id="definitionview" elevation="2">
      <div id="definitioninfo">
        <div class="subhead">General info</div>
        <paper-input label="Case name" value="{{definitioninfo.caseName}}" readonly always-float-label></paper-input>
        <paper-input label="Case Description" value="{{definitioninfo.caseDescription}}" readonly always-float-label></paper-input>

        <template is="dom-if" if="{{caseparams.length}}">
          <paper-divider margin></paper-divider>
          <div class="subhead">Case Input Parameters</div>
          <template is="dom-repeat" items="{{caseparams}}">
            <paper-input label="{{item.name}}" value="{{item.value}}" always-float-label></paper-input>
          </template>
        </template>
        <paper-fab id="start" class="bottom-right" icon="av:play-arrow" on-tap="_startCase"></paper-fab>
        <paper-tooltip for="start" position="top">start case</paper-tooltip>
      </div>
    </paper-card>
    <paper-toast id="error" text="Starting the case failed"></paper-toast>
    <paper-toast id="success" text="foo"></paper-toast>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cafienne-definition-view',

      properties: {
        definition: {
          type: Object,
          observer: '_definitionReceived'
        },
        definitioninfo: {
          type: Object,
          notify: true,
          value: {}
        },
        startcase: {
          type: Object,
          value: {}
        },
        caseparams: {
          type: Array,
          notify: true
        }
      },

      _definitionReceived: function() {
        this.caseparams = [];
        var definitionFile = this.definition.definitions.substr(0, this.definition.definitions.indexOf('.'));
        this.$.getDefinitionXML.url = ['http://localhost:18082/repository/load', definitionFile].join('/');
        this.$.getDefinitionXML.headers = {'X-AUTH-CAFIENNE' : sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.getDefinitionXML.generateRequest();
      },

      _getDefinitionInfo: function() {
        var mainCase = this.$.getDefinitionXML.lastResponse.getElementsByTagName('case')[0];
        var caseName = mainCase.getAttribute('name');
        var caseDescription = mainCase.getAttribute('description');
        this.definitioninfo = {caseName: caseName, caseDescription: caseDescription};
        var params = [];
        // proces case input params
        var caseInputParams = mainCase.getElementsByTagName('input');

        if (caseInputParams.length > 0) {
          for (var i = 0; i < caseInputParams.length; i++) {
            var input = {};
            input.name = caseInputParams[i].getAttribute('name');
            input.value = '';
            params.push(input);
            //console.log(input);
          }
          this.caseparams = params;
        }
      },

      _startCase: function() {
        this.startcase = {definition: this.definition.definitions, name: this.definitioninfo.caseName};
        var inputObj = {};
        if(this.caseparams.length > 0) {
          for (var i = 0; i < this.caseparams.length; i++) {
            if (this.caseparams[i].value.length > 0) {
              inputObj[this.caseparams[i].name] = this.caseparams[i].value;
            }
          }
          if(Object.getOwnPropertyNames(inputObj).length > 0) {
            this.startcase.inputs = inputObj;
          }
        }

        var url = 'http://localhost:18082/cases';
        this.$.startCase.headers = {'X-AUTH-CAFIENNE': sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.startCase.body = this.startcase;
        this.$.startCase.url = url;
        this.$.startCase.generateRequest();
      },

      _handleStartCaseResult: function(e) {
        switch (e.type) {
          case 'error':
            this.$.error.show();
            break;
          case 'response':
            this.$.success.text = 'Case started successfully ' + this.startresult.caseInstanceId;
            this.$.success.show();
            break;
        }
      }
    });
  })();
  </script>
</dom-module>
