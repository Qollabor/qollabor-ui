<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">

<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/bower_components/paper-divider/paper-divider.html">

<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="cafienne-definition-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        --paper-input-container-label: {
          color: var(--dark-primary-color);
        }
      }

      #definitionview {
        width: 100%;
        padding-top: 16px;
      }

      paper-icon-button.blue {
        color: var(--paper-light-blue-500);
        --paper-button-flat-focus-color: var(--paper-light-blue-50);
      }
      paper-icon-button.blue:hover {
        background: var(--paper-light-blue-50);
      }

      paper-input {
        max-width: 90%;
        margin: 25px;
      }

      paper-textarea {
        max-width: 90%;
        margin: 25px;
        background-color: rgba(0, 0, 0, 0.05);
      }

      .buttons {
        @apply(--layout-horizontal);
        max-width: calc(97.33% - 32px);
      }
      .spacer {
        @apply(--layout-flex);
      }
      .definitionview {
        @apply(--layout-horizontal);
        max-width: calc(97.33% - 32px);
      }
      .leftcolumn {
        @apply(--layout-flex-3);
        @apply(--layout-vertical);
      }
      .rightcolumn {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .definitioninfo {
        margin: 10px;
      }
      .casefile {
        margin: 10px;
      }
      .plan {
        margin: 10px;
      }
      .card-actions {
        @apply(--layout-horizontal);
      }
    </style>

    <iron-ajax id="getDefinitionXML"
      handle-as="document"
      on-response="_getDefinitionInfo"></iron-ajax>
    <iron-ajax id="startCase"
               method = "POST"
               content-type = "application/json"
               handle-as = "json"
               last-response="{{startresult}}"
               on-response="_handleStartCaseResult"
               on-error="_handleStartCaseResult"></iron-ajax>

     <div class="buttons">
       <paper-icon-button id="back" icon="arrow-back" alt="back to definitions list"></paper-icon-button>
       <paper-icon-button id="refresh" icon="refresh" alt="refresh definition info"></paper-icon-button>
       <span class="spacer"></span>
     </div>

     <div class="definitionview">
       <div class="leftcolumn">
         <paper-card class="definitioninfo" heading="[[definitioninfo.caseName]]">
           <div class="card-content">
             <paper-input label="Case name" value="{{definitioninfo.caseName}}" readonly always-float-label></paper-input>
             <paper-input label="Case Description" value="{{definitioninfo.caseDescription}}" readonly always-float-label></paper-input>
             <template is="dom-if" if="{{caseparams.length}}">
               <paper-divider margin></paper-divider>
               <div class="subhead">Case Input Parameters</div>
               <template is="dom-repeat" items="{{caseparams}}">
                 <paper-input label="{{item.name}}" value="{{item.value}}" always-float-label></paper-input>
               </template>
             </template>
           </div>
           <div class="card-actions">
             <span class="spacer"></span>
             <paper-icon-button id="startcase" class="blue" icon="av:play-arrow" on-tap="_startCase"></paper-icon-button>
             <paper-tooltip for="startcase">start case instance</paper-tooltip>
           </div>
         </paper-card>
       </div>
     </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cafienne-definition-view',

      properties: {
        definition: {
          type: Object,
          value: {}
        },
        definitionName: {
          type: String,
          value: '',
          observer: '_definitionReceived'
        },
        definitioninfo: {
          type: Object,
          notify: true,
          value: {}
        },
        startcase: {
          type: Object,
          value: {}
        },
        caseparams: {
          type: Array,
          notify: true
        }
      },

      listeners: {
        'back.tap': '_buttonPressed',
        'refresh.tap': '_buttonPressed'
      },

      _definitionReceived: function() {
        if(this.definitionName !== '') {
          this.caseparams = [];
          var definitionFile = this.definitionName.substr(0, this.definitionName.indexOf('.'));
          this.$.getDefinitionXML.url = ['http://localhost:18082/repository/load', definitionFile].join('/');
          this.$.getDefinitionXML.headers = {'X-AUTH-CAFIENNE' : sessionStorage.getItem('X-AUTH-CAFIENNE')};
          this.$.getDefinitionXML.generateRequest();
        }
      },

      _getDefinitionInfo: function() {
        var mainCase = this.$.getDefinitionXML.lastResponse.getElementsByTagName('case')[0];
        var caseName = mainCase.getAttribute('name');
        var caseDescription = mainCase.getAttribute('description');
        this.definitioninfo = {caseName: caseName, caseDescription: caseDescription};
        var params = [];
        // proces case input params
        var caseInputParams = mainCase.getElementsByTagName('input');

        if (caseInputParams.length > 0) {
          for (var i = 0; i < caseInputParams.length; i++) {
            var input = {};
            input.name = caseInputParams[i].getAttribute('name');
            input.value = '';
            params.push(input);
            //console.log(input);
          }
          this.caseparams = params;
        }
      },

      _startCase: function() {
        this.startcase = {definition: this.definitionName, name: this.definitioninfo.caseName};
        var inputObj = {};
        if(this.caseparams.length > 0) {
          for (var i = 0; i < this.caseparams.length; i++) {
            if (this.caseparams[i].value.length > 0) {
              inputObj[this.caseparams[i].name] = this.caseparams[i].value;
            }
          }
          if(Object.getOwnPropertyNames(inputObj).length > 0) {
            this.startcase.inputs = inputObj;
          }
        }

        var url = 'http://localhost:18082/cases';
        this.$.startCase.headers = {'X-AUTH-CAFIENNE': sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.startCase.body = this.startcase;
        this.$.startCase.url = url;
        this.$.startCase.generateRequest();
      },

      _handleStartCaseResult: function(e) {
        switch (e.type) {
          case 'error':
            app.showToast('error', 'Unable to start case instance', 3000, true);
            break;
          case 'response':
            var message = 'Case started successfully ' + this.startresult.caseInstanceId;
            app.showToast('success', message, 3000, false);
            break;
        }
      },

      _buttonPressed: function(e) {
        switch (e.target.parentElement.id) {
          case 'back':
            page.redirect('/definitions');
            break;
          case 'refresh':
            this._definitionReceived();
            break;
        }
      }

    });
  })();
  </script>
</dom-module>
