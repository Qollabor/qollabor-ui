<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-fab-transitions/paper-fab-transitions.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../bower_components/paper-divider/paper-divider.html">
<link rel="import" href="../../bower_components/mat-subheader/mat-subheader.html">


<dom-module id="task-info">
  <template>
    <!-- ajax calls -->
    <iron-ajax id="makePlanItemTransition"
               method="POST"
               content-type="application/json"
               handle-as="json"
               last-response="{{transitionresult}}"
               on-error="_handleTransitionResponse"
               on-response="_handleTransitionResponse"></iron-ajax>

    <style>
      :host {
        display: block;
      }

      .bottom-right {
        position: absolute;
        bottom: 10px;
        right: 10px;
      }

      paper-input {
        max-width: 90%;
      }

      paper-toast {
        z-index: 1000;
      }

    </style>
    <div id="taskinfo">
      <mat-subheader label="General info"></mat-subheader>
      <paper-input label="Task name" value="{{task.taskName}}" readonly always-float-label></paper-input>
      <paper-input label="Task InstanceId" value="{{task.id}}" readonly always-float-label></paper-input>
      <paper-input label="Case" value="{{task.caseDefinition}}" readonly always-float-label></paper-input>
      <paper-input label="User" value="{{task.user}}" readonly always-float-label></paper-input>
      <paper-input label="Role" value="{{task.role}}" readonly always-float-label></paper-input>
    </div>
    <template is="dom-if" if="{{task.parameters.keys.length}}">
      <div id="taskparams">
        <paper-divider></paper-divider>
        <mat-subheader label="Task parameters"></mat-subheader>
      </div>
    </template>
    <!-- action buttons -->
    <paper-fab-speed-dial id="taskactions" class="bottom-right" direction="top" onmouseover="this.open()">
      <paper-fab icon="more-vert" class="dropdown-trigger"></paper-fab>
      <div class="dropdown-content">
        <paper-fab id="resume" mini icon="av:play-arrow" on-tap="_handleTaskAction" data-value="resume"></paper-fab>
        <paper-tooltip for="resume" position="left">resume</paper-tooltip>
        <paper-fab id="suspend" mini icon="av:pause" on-tap="_handleTaskAction" data-value="suspend"></paper-fab>
        <paper-tooltip for="suspend" position="left">suspend</paper-tooltip>
        <paper-fab id="terminate" mini icon="clear" on-tap="_handleTaskAction" data-value="terminate"></paper-fab>
        <paper-tooltip for="terminate" position="left">terminate</paper-tooltip>
        <paper-fab id="complete" mini icon="check" on-tap="_handleTaskAction" data-value="complete"></paper-fab>
        <paper-tooltip for="complete" position="left">complete</paper-tooltip>
      </div>
    </paper-fab-speed-dial>
    <paper-toast id="transitionerror" text="foo"><span role="button" tabindex="0" style="color: #eeff41;margin: 10px" onclick="console.log('CLOSE')">CLOSE</span></paper-toast>
    <paper-toast id="transitionsuccess" text="foo"><span role="button" tabindex="0" style="color: #eeff41;margin: 10px" onclick="console.log('OK')">OK</span></paper-toast>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'task-info',

      properties: {
        task: {
          type: Object,
          notify: true
        },
        caseinstanceid: {
          type: String
        }
      },

      _handleTaskAction: function(e) {
        var transition = e.target.dataHost.getAttribute('data-value');
        console.log('Transition: ' + transition + ' for ' + this.task.id +  ' case: ' + this.caseinstanceid);
        this.$.makePlanItemTransition.headers = {'X-AUTH-CAFIENNE': sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.makePlanItemTransition.url = ['http://localhost:18082/cases', this.caseinstanceid, 'planitems', this.task.id, transition].join('/');
        this.$.makePlanItemTransition.generateRequest();
      },

      _handleTransitionResponse: function(e, request) {

        console.log(e);
        console.log(request);
        switch (e.type) {
          case 'error':
            this.$.transitionerror.text = 'Transition failed!';
            this.$.transitionerror.show();
            break;
          case 'response':
            console.log(this.transitionresult);
            this.$.transitionsuccess.text = 'Transition successful!';
            this.$.transitionsuccess.show();
            break;
        }

      }
    });
  })();
  </script>
</dom-module>
