<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">

<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">

<link rel="import" href="/bower_components/time-element/time-format.html">

<link rel="import" href="../../elements/cafienne-taskactions/cafienne-taskactions.html">
<link rel="import" href="../../elements/case-file/case-file.html">
<link rel="import" href="../../elements/cafienne-timeline/cafienne-timeline.html">

<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="cafienne-task">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      .buttons {
        @apply(--layout-horizontal);
        max-width: calc(97.33% - 32px);
      }
      .spacer {
        @apply(--layout-flex);
      }
      .taskview {
        @apply(--layout-horizontal);
        max-width: calc(97.33% - 32px);
      }
      .leftcolumn {
        @apply(--layout-flex-3);
        @apply(--layout-vertical);
      }
      .rightcolumn {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .taskinfo {
        margin: 10px;
      }
      .casefile {
        margin: 10px;
      }
      .plan {
        margin: 10px;
      }
      .card-actions {
        @apply(--layout-horizontal);
      }
    </style>

    <iron-ajax id="getTaskDetails"
      handle-as="json"
      on-response="_handleTaskResponse"
      on-error="_handleTaskResponse"></iron-ajax>
    <iron-ajax id="getCaseInfo"
      auto
      handle-as="json"
      on-response="_handleCaseResponse" on-error="_handleCaseResponse"></iron-ajax>

      <div class="buttons">
        <paper-icon-button id="back" icon="arrow-back" alt="back to tasklist"></paper-icon-button>
        <paper-icon-button id="refresh" icon="refresh" alt="refresh task info"></paper-icon-button>
        <span class="spacer"></span>
      </div>


      <div class="taskview">
        <div class="leftcolumn">
          <paper-card class="taskinfo" heading="[[task.taskName]]">
            <div class="card-content">
              <paper-input label="Task name" value="[[task.taskName]]" readonly always-float-label></paper-input>
              <paper-input label="Task InstanceId" value="[[task.id]]" readonly always-float-label></paper-input>
              <paper-input label="Task Last Modified" value="[[_formatLastModified(task.lastModified)]]" readonly always-float-label></paper-input>
              <paper-input label="Case" value="[[task.caseDefinition]]" readonly always-float-label></paper-input>
              <paper-input label="User" value="[[task.user]]" readonly always-float-label></paper-input>
              <paper-input label="Role" value="[[task.role]]" readonly always-float-label></paper-input>
            </div>
            <div class="card-actions">
              <span class="spacer"></span>
              <cafienne-taskactions task-state="Active" task-id="[[task.id]]" case-instance-id="[[task.caseId]]"></cafienne-taskactions>
            </div>
          </paper-card>
          <paper-card class="casefile" heading="Case file">
            <div class="card-content">
              <case-file casefile="[[caseInfo.file]]"></case-file>
            </div>
            <div class="card-actions">
              <span class="spacer"></span>
              <paper-icon-button id="save-casefile" icon="save" alt="save changes to casefile"></paper-icon-button>
            </div>
          </paper-card>
        </div>
        <div class="rightcolumn">
          <paper-card class="plan" heading="Activities">
            <div class="card-content">
              <cafienne-timeline planitems="[[caseInfo.plan.items]]"></cafienne-timeline>
            </div>
          </paper-card>
        </div>
      </div>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cafienne-task',

      properties: {
        task: {
          type: Object,
          value: {},
          notify: true
        },
        taskId: {
          type: String,
          observer: '_taskIdChanged',
          reflectToAttribute: true
        },
        caseInfo: {
          type: Object,
          value: {},
          notify: true
        }
      },

      listeners: {
        'back.tap': '_buttonPressed',
        'refresh.tap': '_buttonPressed'
      },

      _taskIdChanged: function() {
        if(this.taskId !== '') {
          this.$.getTaskDetails.headers = {'X-AUTH-CAFIENNE' : sessionStorage.getItem('X-AUTH-CAFIENNE')};
          this.$.getTaskDetails.url = ['http://localhost:18082/tasks', this.taskId].join('/');
          this.$.getTaskDetails.generateRequest();
        }
      },

      _handleTaskResponse: function(e) {
        switch (e.type) {
          case 'error':
            app.showToast('error', 'Unable to get task data', 3000, true);
            break;
          case 'response':
            this.task = this.$.getTaskDetails.lastResponse._2;
            this.$.getCaseInfo.url = ['http://localhost:18082/cases', this.task.caseId].join('/');
            app.showToast('success', 'Task data retreived', 1500, false);
            break;
          }
        },

        _handleCaseResponse: function(e) {
          switch (e.type) {
            case 'error':
              app.showToast('error', 'Unable to get case info for this task', 3000, true);
              break;
            case 'response':
              this.caseInfo = this.$.getCaseInfo.lastResponse._2;
              break;
            default:
              console.log('Fetching case info failed');
          }
        },

        _buttonPressed: function(e) {
          switch (e.target.parentElement.id) {
            case 'back':
              page.redirect('/tasks');
              break;
            case 'refresh':
              this._taskIdChanged();
              break;
          }
        },

        _formatLastModified: function(dateString) {
          var locale = navigator.language || navigator.userLanguage;
          return new Date(dateString).toLocaleString('en-GB');
        }

    });
  })();
  </script>
</dom-module>
