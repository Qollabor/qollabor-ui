<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">

<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../elements/case-file/case-file.html">
<link rel="import" href="../../elements/discretionary-items/discretionary-items.html">
<link rel="import" href="../../elements/cafienne-plan/cafienne-plan.html">
<link rel="import" href="../../elements/cafienne-timeline/cafienne-timeline.html">

<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="cafienne-case">
  <template>
  <style include="shared-styles">
    :host {
      display: block;
    }

    paper-icon-button.red {
      color: var(--paper-red-500);
      --paper-button-flat-focus-color: var(--paper-red-50);
    }
    paper-icon-button.red:hover {
      background: var(--paper-red-50);
    }
    paper-icon-button.green {
      color: var(--paper-green-500);
      --paper-button-flat-focus-color: var(--paper-green-50);
    }
    paper-icon-button.green:hover {
      background: var(--paper-green-50);
    }

    .buttons {
      @apply(--layout-horizontal);
      max-width: calc(97.33% - 32px);
    }
    .spacer {
      @apply(--layout-flex);
    }
    .caseview {
      @apply(--layout-horizontal);
      max-width: calc(97.33% - 32px);
    }
    .leftcolumn {
      @apply(--layout-flex-3);
      @apply(--layout-vertical);
    }
    .rightcolumn {
      @apply(--layout-flex);
      @apply(--layout-vertical);
    }
    .caseinfo {
      margin: 10px;
    }
    .casefile {
      margin: 10px;
    }
    .discretionaryitems {
      margin: 10px;
    }
    .plan {
      margin: 10px;
    }
    .card-actions {
      @apply(--layout-horizontal);
    }
    .footer {
      @apply(--layout-horizontal);
      height: 32px;
    }
  </style>

  <iron-ajax id="getCaseDetails"
    handle-as="json"
    on-response="_handleCaseDetailsResponse"
    on-error="_handleCaseDetailsResponse"></iron-ajax>
  <iron-ajax id="getCaseStats"
    auto
    handle-as="json"
    on-response="_handleCaseStatsResponse" on-error="_handleCaseStatsResponse"></iron-ajax>
  <iron-ajax id="makePlanItemTransition"
             method="POST"
             content-type="application/json"
             handle-as="json"
             last-response="{{transitionresult}}"
             on-error="_handleTransitionResponse"
             on-response="_handleTransitionResponse"></iron-ajax>

    <div class="buttons">
      <paper-icon-button id="back" icon="arrow-back" alt="back to caselist"></paper-icon-button>
      <paper-icon-button id="refresh" icon="refresh" alt="refresh case info"></paper-icon-button>
      <span class="spacer"></span>
    </div>


    <div class="caseview">
      <div class="leftcolumn">
        <paper-card class="caseinfo" heading="[[casePlan.name]]">
          <div class="card-content">
            <paper-input label="Case" value="[[case.definition]]" readonly always-float-label></paper-input>
            <paper-input label="Case InstanceId" value="[[case.id]]" readonly always-float-label></paper-input>
            <paper-input label="Root InstanceId" value="[[case.rootCaseId]]" readonly always-float-label></paper-input>
            <paper-input label="Parent InstanceId" value="[[case.parentId]]" readonly always-float-label></paper-input>
            <paper-input label="Current State" value="[[casePlan.currentState]]" readonly always-float-label></paper-input>
            <paper-input label="Last Modified" value$="[[_formatDate(casePlan.lastModified, 'en-GB')]]" readonly always-float-label></paper-input>
          </div>
          <div class="card-actions">
            <span class="spacer"></span>
            <paper-icon-button id="complete" class="green" icon="check" alt="complete this case instance"></paper-icon-button>
            <paper-tooltip for="complete" position="left">complete</paper-tooltip>
            <paper-icon-button id="terminate" class="red" icon="clear" alt="terminate this case instance"></paper-icon-button>
            <paper-tooltip for="terminate" position="left">terminate</paper-tooltip>
          </div>
        </paper-card>
        <paper-card class="casefile" heading="Case file">
          <div class="card-content">
            <case-file casefile="[[case.file]]"></case-file>
          </div>
          <div class="card-actions">
            <span class="spacer"></span>
            <paper-icon-button id="save-casefile" icon="save" alt="save changes to casefile"></paper-icon-button>
          </div>
        </paper-card>
        <paper-card class="discretionaryitems" heading="Discretionary items">
          <div class="card-content">
            <discretionary-items caseinstanceid={{case.id}}></discretionary-items>
          </div>
        </paper-card>
        <paper-card class="plan" heading="Plan items">
          <cafienne-plan planitems="[[case.plan.items]]"></cafienne-plan>
        </paper-card>
      </div>
      <div class="rightcolumn">
        <paper-card class="plan" heading="Activities">
          <div class="card-content">
            <cafienne-timeline planitems=[[case.plan.items]]></cafienne-timeline>
          </div>
        </paper-card>
      </div>
    </div>
    <div class="footer">
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cafienne-case',

      properties: {
        case: {
          type: Object,
          value: {},
          notify: true
        },
        caseId: {
          type: String,
          observer: '_caseIdChanged',
          reflectToAttribute: true
        },
        caseStats: {
          type: Object,
          value: {},
          notify: true
        },
        casePlan: {
          type: Object,
          value: {},
          notify: true
        }
      },

      listeners: {
        'back.tap': '_buttonPressed',
        'refresh.tap': '_buttonPressed',
        'complete.tap': '_buttonPressed',
        'terminate.tap': '_buttonPressed'

      },

      _caseIdChanged: function() {
        if(this.caseId !== '') {
          this.$.getCaseDetails.headers = {'X-AUTH-CAFIENNE' : sessionStorage.getItem('X-AUTH-CAFIENNE')};
          this.$.getCaseDetails.url = ['http://localhost:18082/cases', this.caseId].join('/');
          this.$.getCaseDetails.generateRequest();
        }
      },

      _handleCaseDetailsResponse: function(e) {
        switch (e.type) {
          case 'error':
            app.showToast('error', 'Unable to get case data', 3000, true);
            break;
          case 'response':
            this.case = this.$.getCaseDetails.lastResponse._2;
            this.casePlan = this.case.plan.items.filter(function(i) {if (i.type === 'CasePlan') {return i;}})[0];
            //this.$.getCaseInfo.url = ['http://localhost:18082/cases', this.case.id].join('/');
            app.showToast('success', 'Case data retreived', 1500, false);
            break;
          }
        },

        _handleCaseResponse: function(e) {
          switch (e.type) {
            case 'error':
              app.showToast('error', 'Unable to get case info for this case', 3000, true);
              break;
            case 'response':
              this.caseInfo = this.$.getCaseInfo.lastResponse._2;
              break;
            default:
              console.log('Fetching case info failed');
          }
        },

        _makeCaseTransition: function(transition) {
          console.log('Transition: ' + transition + ' for ' + this.casePlan.id +  ' case: ' + this.case.id);
          this.$.makePlanItemTransition.headers = {'X-AUTH-CAFIENNE': sessionStorage.getItem('X-AUTH-CAFIENNE')};
          this.$.makePlanItemTransition.url = ['http://localhost:18082/cases', this.case.id, 'planitems', this.casePlan.id, transition].join('/');
          this.$.makePlanItemTransition.generateRequest();
        },

        _handleTransitionResponse: function(e) {
          switch (e.type) {
            case 'error':
              app.showToast('error', 'Transition failed', 3000, true);
              this._caseIdChanged();
              break;
            case 'response':
              app.showToast('success', 'Transition successful', 3000, true);
              this._caseIdChanged();
              break;
          }
        },

        _buttonPressed: function(e) {

          switch (e.target.parentElement.id) {
            case 'back':
              page.redirect('/cases');
              break;
            case 'refresh':
              this._caseIdChanged();
              break;
            case 'complete':
              this._makeCaseTransition('complete');
              break;
            case 'terminate':
              this._makeCaseTransition('terminate');
              break;
          }
        },

        _formatDate: function(dateString, locale) {
          return new Date(dateString).toLocaleString(locale);
        }
    });
  })();
  </script>
</dom-module>
