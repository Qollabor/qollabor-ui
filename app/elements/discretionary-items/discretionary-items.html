<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-list/iron-list.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="discretionary-items">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      .title {
        font-weight: bold;
      }

      .planitem {
        border-bottom: 1px solid rgba(0, 0, 0, 0.3);
        @apply(--layout-horizontal);
        width: auto;
      }
      .wrap {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .center {
        @apply(--layout-center-center);
      }

    </style>

    <iron-ajax id="getDiscretionaryItemsForCase" auto
               last-response = "{{discretionaryitems}}"
               handle-as = "json"></iron-ajax>
    <iron-ajax id="planDiscretionaryItem"
               method = "POST"
               content-type = "application/json"
               handle-as = "json"
               last-response="{{planresult}}"
               on-response="_handlePlanResult"
               on-error="_handlePlanResult"></iron-ajax>


      <div id="discretionaryitems">
        <iron-list id="list" items="{{discretionaryitems.discretionaryItems}}">
          <template>
            <div class="wrap">
              <paper-icon-button id="plan" class="blue" icon="av:play-arrow" item-icon on-tap="_planItem"></paper-icon-button>
              <div class="planitem">
                    <span class="title">{{item.name}}</span>
                    <span class="pad">{{item.parent}}</span>
                    <span class="pad tag center">{{item.type}}</span>
              </div>
            </div>
          </template>
        </iron-list>
      </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'discretionary-items',

      properties: {
        caseinstanceid: {
          type: String,
          observer: '_caseInstanceIdReceived'
        },
        discretionaryitems: {
          type: Object,
          notify: true
        }
      },

      _caseInstanceIdReceived: function() {
        this.$.getDiscretionaryItemsForCase.url = ['http://localhost:18082/cases', this.caseinstanceid, 'discretionaryitems'].join('/');
        this.$.getDiscretionaryItemsForCase.headers = {'X-AUTH-CAFIENNE' : sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.getDiscretionaryItemsForCase.generateRequest();

      },

      _planItem: function(e) {
        var itemName = e.model.item.name;
        var url = ['http://localhost:18082/cases', this.caseinstanceid, 'discretionaryitems', 'plan'].join('/');
        this.$.planDiscretionaryItem.headers = {'X-AUTH-CAFIENNE': sessionStorage.getItem('X-AUTH-CAFIENNE')};
        this.$.planDiscretionaryItem.body = {'name': itemName};
        this.$.planDiscretionaryItem.url = url;
        this.$.planDiscretionaryItem.generateRequest();
      },

      _handlePlanResult: function(e) {
        switch (e.type) {
          case 'error':
                app.showToast('error', 'Unable to plan item', 3000, true);
                break;
          case 'response':
                var message = 'Item planned succesfully ' + this.planresult.planItemId;
                app.showToast('success', message, 3000, false);
                break;
        }
      }
    });
  })();
  </script>
</dom-module>
